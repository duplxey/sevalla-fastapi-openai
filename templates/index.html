<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>sevalla-fastapi-openai</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="container">
            <h3 class="mt-3">
                <a href="https://github.com/duplxey/sevalla-fastapi-openai">
                    sevalla-fastapi-openai
                </a>
            </h3>
            <div class="mt-5 mb-3">
                <h5 id="input-label" class="text-center">
                    Hola ðŸ‘‹, what is your prompt?
                </h5>
                <div class="gap-2 my-3">
                    <form id="form" class="d-flex gap-2" autocomplete="off">
                        <input id="input" class="form-control flex-grow-1" aria-label="input-label" autocomplete="off" placeholder="Type your prompt...">
                        <button id="submitButton" type="submit" class="btn btn-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
            <div>
                <label for="output-input" class="form-label">Streamed response:</label>
                <textarea id="output-input" class="form-control" aria-label="output-label" rows="10" autocomplete="off"></textarea>
            </div>
        </div>
        <script>
            const form = document.getElementById("form");
            const input = document.getElementById("input");
            const submitButton = document.getElementById("submitButton");
            const output = document.getElementById("output-input");

            form.addEventListener("submit", (e) => {
                e.preventDefault();

                // Ensure the input is not empty
                if (!input.value) {
                    return;
                }

                input.disabled = true;
                submitButton.disabled = true;
                output.value = "";

                // Initialize a SSE connection to receive streamed responses
                const urlEncodedMessage = encodeURIComponent(input.value);
                const eventSource = new EventSource(`/chat-stream?message=${urlEncodedMessage}`);

                // Handle SSE events (start, <unnamed>, end, error)
                eventSource.addEventListener("start", () => {
                    console.log("Stream started...");
                });

                eventSource.onmessage = (event) => {
                    console.log(event.data);
                    output.value += event.data;
                };

                eventSource.addEventListener("end", () => {
                    console.log("Stream complete.");
                    eventSource.close();
                });

                eventSource.onerror = (err) => {
                    console.error("Oops, something went wrong with SSE...");
                    console.error(err);
                };
            });
        </script>
    </body>
</html>
